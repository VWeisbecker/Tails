---
title: "Tail study"
author: "Vera Weisbecker and Cruise Speck"
date: "5 December 2018"
output: html_document
---


## Load required packages and data
```{r, warnings=FALSE}
library(ape)
library(geiger)

```

#prepare data and trees; this includes deleting entries with NAS in the main averages
```{r}
# The data, partition between marsupials and rodents
Data=read.csv("../Data/Full_dataset.csv")

#log10 transform all numerical data

#extract numerical columns
numcols=as.data.frame(Data[,2:28])

#turn NAs into 1 so they turn into easily replaceable zeroes without messing with the logging
numcols[is.na(numcols)]<-1

#log transform
numcols_log10=log10(numcols)

#replace 0s with NAS again
numcols_log10[numcols_log10==0]<-NA

#replace original data with logged data. +1 because 2:34 is 33. I wish I knew a less pedestrian way of doing this...
logdata=Data
logdata[,2:(ncol(numcols)+1)]=numcols_log10

#partition datasets; this cannot be automated easily so need to check for accuracy by looking at dataset

#exclude wombats who are outliers using grep (which returns the number of the row that has the species name)
Data=Data[-((grep("Vombatus_ursinus", Data$Species)):(grep("Lasiorhinus_latifrons", Data$Species))),]


#deleting all entries that have NAs in their main data and locomotor use; this means some species don't have weight data. There is also one specie of rodent deleted because of lack of 
Data=Data[-which(is.na( Data$Tl_mm)) ,]
Data=Data[-which(is.na(Data$Locomotor_use)),]



#drop unused "Rattus" level from Data

Data$Order<-  droplevels(Data$Order, exclude="Rattus")

```

#import and process trees

```{r}
Tree=read.nexus("../Data/MayCollando_Marsupial_tree.nex")


```


# Synchronize trees and species by reducing tree to the data available; this has been checked for typos taht cause non-matches (fixed above in the code containing grep). The below culls species that are not in the tree from the data, and species that are not in the data from the tree.
```{r}
#138 species left; no data that are not present in tree

namecheck=name.check(Tree,Data)
Tree_synch=drop.tip(Tree,namecheck$tree_not_data)
Data_synch= Data[-which(rownames(Data) %in% namecheck$data_not_tree),]
name.check(Tree_synch,Data_synch)



```
#process trees for the major marsupial orders as well


```{r}

#Dasyuromorphs
dasy_data=mars_synch[which(mars_synch$Order =="Dasyuromorph"),]
dasy_tree=drop.tip(marsTree_synch, name.check(marsTree_synch,dasy_data)$tree_not_data )

#Peramelemorphs
peram_data=mars[which(mars_synch$Order =="Peramelemorph"),]
peram_tree=drop.tip(marsTree_synch, name.check(marsTree_synch,peram_data)$tree_not_data )

#Diprotodontia
dip_data=mars[which(mars_synch$Order =="Diprotodontian"),]
dip_tree=drop.tip(marsTree_synch, name.check(marsTree_synch,dip_data)$tree_not_data )



```

#Processing data for partitions with m/f data available (assuming if m present, f is also present; but some species don't have male/female averages so they get deleted). 
```{r}
mf_mars=mars_synch[which(mars_synch$Tl_Av_F !="NA"),]
mf_mars=mf_mars[which(mf_mars$Wt_Av_F !="NA"),]
#this will give an error if name.check is OK - or at least I only encountered this error if this was the case
mf_marstree=drop.tip(marsTree_synch, name.check(marsTree_synch,mf_mars)$tree_not_data )



```


#Packaging all outputs for analysis

```{r}

#putting all outputs and the initial input ("Full" datasets) into one RDA 
marsFull<-mars
mars<-mars_synch
marsTree<-marsTree_synch

save(marsFull,mars,marsTree, dasy_data, dasy_tree,peram_data, peram_tree,dip_data,dip_tree, mf_mars,mf_marstree, file = "../Data/Processed_Data_for_Pgls.rda")

#save(marsFull,mars,marsTree, dasy_data, dasy_tree,peram_data, peram_tree,dip_data,dip_tree, mf_mars, mf_marstree,  file = "../Data/Processed_Data_for_Pgls.rda")

```
