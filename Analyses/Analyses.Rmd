---
title: "Analyses"
author: "Vera Weisbecker and Cruise Speck"
date: "5 December 2018"
output: html_document
---



## load required packages and processed data



```{r }
library(ape)
library(geiger)
library(phytools)
library(caper)
library(car)
library(multcomp)
library(geomorph)
library(lmSupport)
library(ggplot2)
library(nlme)
library(dplyr)
library(RColorBrewer)

#the "utilities" file contains functions so this analysis page isn't too cluttered
source("../Analyses/Utilities.r")
load(file = "../Data/Processed_Data_for_Pgls.rda")



```

#Is it appropriate to correlate body mass with tail/body length, given the large weight ranges? Testing the hypothesis that within-species body weight maxima are greater relative to body weight minima(i.e. the range is relatively wider), compared to the same ratio in within-species body or tail lengths) - for those species where ranges are available, body mass ranges are substantially greater

```{r}
#return the min/max values to their un-logged form
ratio_Tl=c(10^(marsFull$Tl_max)/10^(marsFull$Tl_min))
ratio_Bl=c(10^(marsFull$Bl_max)/10^(marsFull$Bl_min))
ratio_Wt=c(10^(marsFull$Wt_max)/10^(marsFull$Wt_min))

#Visualizing means of the ratios 
boxplot(ratio_Tl, ratio_Bl,ratio_Wt)

ratios=c(ratio_Tl, ratio_Bl, ratio_Wt)

#The VarDist.test code is in utilities. It runs a Kruskal-Wallis test and then a pairwise wilcoxon test on the ratios
VarDist.test(ratios,3)

boxplot(ratio_Tl, ratio_Bl,ratio_Wt)

#This is not mainly because of the extreme ranges in bandicoots!

ratio_Tl_Band<-ratio_Tl[ - (grep("Macrotis_leucura", marsFull$Species):grep("Echymipera_rufescens", mars$Species))]
ratio_Bl_Band<-ratio_Bl[ - (grep("Macrotis_leucura", marsFull$Species):grep("Echymipera_rufescens", mars$Species))]
ratio_Wt_Band<-ratio_Wt[ - (grep("Macrotis_leucura", marsFull$Species):grep("Echymipera_rufescens", mars$Species))]

ratiosBand=c(ratio_Tl_Band, ratio_Bl_Band, ratio_Wt_Band)
VarDist.test(ratiosBand,3)

par(mfrow=c(1,2))
boxplot(ratio_Tl, ratio_Bl,ratio_Wt, xlab="ratios with bandicoots")
boxplot(ratio_Tl_Band, ratio_Bl_Band,ratio_Wt_Band, xlab="ratios without bandicoots")


```

#is there a difference in tail/body length relationships between the sexes or if we use maximum tail length?

```{r}
#Marsupials:

  ##Re-arrange datasets to put males, femals and averages under each other, turning into a data frame for column names
  
  Males<-cbind(marsFull$Tl_Av_M,marsFull$Bl_Av_M,marsFull$Wt_Av_M, marsFull$Locomotor_use,rep(1,length(marsFull$Tl_Av_M)))
  Females<-cbind(marsFull$Tl_Av_F,marsFull$Bl_Av_F,marsFull$Wt_Av_F,marsFull$Locomotor_use, rep(2,length(marsFull$Tl_Av_F)))
  Averages<-cbind(marsFull$Tl_mm, marsFull$Bl_mm,marsFull$Wt_g, marsFull$Locomotor_use,rep(3,length(marsFull$Bl_mm)))
  
  Combine=rbind(Males, Females,Averages)
  Combine=as.data.frame(Combine)
  colnames(Combine) <-c("Tl","Bl","Wt","Locomotor_use","Sex")
  Combine$Sex<-as.factor(Combine$Sex)
  Combine$Locomotor_use<-as.factor(Combine$Locomotor_use)
  
  ##Are there differences in slope of Tail length and body LENGTH according to locomotor use, sex, or averages between sexes?
  Sex_locomotion=summary(lm(Combine$Tl~Combine$Bl*Combine$Sex*Combine$Locomotor_use))
  Sex_locomotion=aov (Combine$Tl~Combine$Bl*Combine$Sex*Combine$Locomotor_use)
  
  ##If significant interactions, use
  testInteractions(Sex_locomotion)
  #if not, re-run without interactions; if any intercept is significant, run something like the below
  TukeyHSD(MaleFemaleaov,which='Sex', data=Combine )
  
  ##Are there differences in slope of Tail length and body WEIGHT according to locomotor use, sex, or averages between sexes?
  Sex_locomotion=summary(lm(Combine$Tl~Combine$Wt *Combine$Sex*Combine$Locomotor_use))
  Sex_locomotion=aov (Combine$Tl~Combine$Wt*Combine$Sex*Combine$Locomotor_use)
  
  ##If significant interactions, use
  testInteractions(Sex_locomotion)
  #if not, re-run without interactions; if any intercept is significant, run something like the below
  TukeyHSD(MaleFemaleaov,which='Sex', data=Combine )

#Rodents:

  Males<-cbind(rodFull$Tl_Av_M,rodFull$Bl_Av_M,rodFull$Wt_Av_M, rodFull$Locomotor_use,rep(1,length(rodFull$Tl_Av_M)))
  Females<-cbind(rodFull$Tl_Av_F,rodFull$Bl_Av_F,rodFull$Wt_Av_F,rodFull$Locomotor_use, rep(2,length(rodFull$Tl_Av_F)))
  Averages<-cbind(rodFull$Tl_mm, rodFull$Bl_mm,rodFull$Wt_g, rodFull$Locomotor_use,rep(3,length(rodFull$Bl_mm)))
  
  Combine=rbind(Males, Females,Averages)
  Combine=as.data.frame(Combine)
  colnames(Combine) <-c("Tl","Bl","Wt","Locomotor_use","Sex")
  Combine$Sex<-as.factor(Combine$Sex)
  Combine$Locomotor_use<-as.factor(Combine$Locomotor_use)
  
  #Are there differences in slope of Tail length and body LENGTH according to locomotor use, sex, or averages between sexes?
  Sex_locomotion=summary(lm(Combine$Tl~Combine$Bl*Combine$Sex*Combine$Locomotor_use))
  Sex_locomotion=aov (Combine$Tl~Combine$Bl*Combine$Sex*Combine$Locomotor_use)
  
  #If significant interactions, use
  testInteractions(Sex_locomotion)
  #if not, re-run without interactions; if any intercept is significant, run something like the below
  TukeyHSD(MaleFemaleaov,which='Sex', data=Combine )
  
  #Are there differences in slope of Tail length and body WEIGHT according to locomotor use, sex, or averages between sexes?
  Sex_locomotion=summary(lm(Combine$Tl~Combine$Wt *Combine$Sex*Combine$Locomotor_use))
  Sex_locomotion=aov (Combine$Tl~Combine$Wt*Combine$Sex*Combine$Locomotor_use)
  
  #If significant interactions, use
  testInteractions(Sex_locomotion)
  #if not, re-run without interactions; if any intercept is significant, run something like the below
  TukeyHSD(MaleFemaleaov,which='Sex', data=Combine )


```

# Do Tail lengths scale differently compared to body lengths/weights in species with different locomotor modes? Fill in as the data are there

```{r}

#Marsupials
    
  ##Tail vs body LENGTH
    TB=find.best.model(Tl_mm~Bl_mm*Locomotor_use,marsTree,mars);TB$AIC_Weights
     
    ###look at the model summary of the most likely model, e.g. 
    TB$Model_summaries$corBrownian$tTable
      
    ###if the interactions are not significant (i.e. slopes are not sig. different), drop them    
    TB_no_inter=find.best.model(Tl_mm~Bl_mm+Locomotor_use,marsTree,mars);TB$AIC_Weights
    TB_no_inter$Model_summaries$corBrownian$tTable
    anova(TB_no_inter$Model_summaries$corBrownian, type="marginal")
   
     #or use phytools - not sure how to deal with the label warnings
    Locomotor_use=c(mars$Locomotor_use)
    names(Locomotor_use)<-names(mars$Species)
    phylANOVA(marsTree,Locomotor_use,mars$Tl_mm)
    
     ###using the smaller, m/f specific datasets note THIS NEEDS LARGE NUMBERS OF DATA SO DOES NOT ALWAYS DO INTERACTIONS
    TBF=find.best.model(Tl_Av_F ~Bl_Av_F+Locomotor_use,mf_marstree, mf_mars);TB$AIC_Weights
    anova(TBF$Model_summaries$corPagel, type="marginal")
    
    TBM=find.best.model(Tl_Av_M~Bl_Av_M+Locomotor_use,mf_marstree,mf_mars); TB$AIC_Weights
    anova(TBM$Model_summaries$corPagel, type="marginal")
    
  ##Tail vs body WEIGHT
    TW=find.best.model(Tl_mm~Wt_g*Locomotor_use,marsTree,mars);TW$AIC_Weights
    anova(TW$Model_summaries$corBrownian, type="marginal")  
    
    ###no interactions, therefore
    TW_no_inter=find.best.model(Tl_mm~Wt_g+Locomotor_use,marsTree,mars);TW$AIC_Weights
    anova(TW_no_inter$Model_summaries$corBrownian, type="marginal") 
    
    
    ###using the smaller, m/f specific datasets
    TWF=find.best.model(Tl_Av_F ~Wt_Av_F+Locomotor_use,mf_marstree, mf_mars);TW$AIC_Weights
    anova(TWF$Model_summaries$corBrownian, type="marginal") 
      
    TWM=find.best.model(Tl_Av_M~Wt_Av_M+Locomotor_use,mf_marstree,mf_mars);TW$AIC_Weights
    anova(TWF$Model_summaries$corBrownian, type="marginal") 
  
    
#Rodents
    
  ##Tail vs body LENGTH
    TB=find.best.model(Tl_mm~Bl*Locomotor_use,rodTree,rod);TB$AIC_Weights
    TB$Model_summaries$corBrownian$tTable
      
    ###using the smaller, m/f specific datasets
    TB=find.best.model(Tl_Av_F ~Bl_Av_F*Locomotor_use,rodTree, mf_rod);TB$AIC_Weights
    TB$Model_summaries$corBrownian$tTable
      
    TB=find.best.model(Tl_Av_M~Wt_Av_M*Locomotor_use,rodTree,mf_rod);TB$AIC_Weights
    TB$Model_summaries$corBrownian$tTable
      
  ##Tail vs body WEIGHT
    TW=find.best.model(Tl_mm~Wt_g*Locomotor_use,rodTree,rod);TW$AIC_Weights
     
    ###look at the model summary of the most likely model, e.g. 
    TW$Model_summaries$corBrownian$tTable
      
    ###using the smaller, m/f specific datasets
    TW=find.best.model(Tl_Av_F ~Wt_Av_F*Locomotor_use,rodTree, mf_rod);TW$AIC_Weights
    TW$Model_summaries$corBrownian$tTable
      
    TW=find.best.model(Tl_Av_M~Wt_Av_M*Locomotor_use,rodTree,mf_rod);TW$AIC_Weights
    TW$Model_summaries$corBrownian$tTable
   
```

#Plotting male, female and averages 

```{r}
  
#plot male-only, female-only, and averaged datasets together
par(mfrow=c(1,2))

plot(mars$Bl_Av_M,mars$Tl_Av_M, col="red", pch=19);points(mars$Bl_Av_F,mars$Tl_Av_F, col="blue", pch=19);points(mars$Bl_mm,mars$Tl_mm, col="green", pch=19);abline(lm(mars$Tl_Av_M~mars$Bl_Av_M), col="red");abline(lm(mars$Tl_Av_F~mars$Bl_Av_F), col="blue"); abline(lm(mars$Tl_mm~mars$Bl_mm), col="green")


plot(mars$Wt_Av_M,mars$Tl_Av_M, col="red", pch=19);points(mars$Wt_Av_F,mars$Tl_Av_F, col="blue", pch=19);points(mars$Wt_g,mars$Tl_mm, col="green", pch=19);abline(lm(mars$Tl_Av_M~mars$Wt_Av_M), col="red");abline(lm(mars$Tl_Av_F~mars$Wt_Av_F), col="blue"); abline(lm(mars$Tl_mm~mars$Wt_g), col="green")  


```
#Plotting according to locomotor mode

```{r}

par(mfrow=c(1,2))

#colour 
colsOrder=brewer.pal(n=length(levels(mars$Order)), name="Dark2")
colsLoco=brewer.pal(n=length(levels(mars$Locomotor_use)), name="Dark2")

plot(mars$Tl_mm~mars$Bl_mm, col=cols[mars$Order], pch=19, xlab="log Body length", ylab="log Tail length" );legend("topleft", c("Dasyuromorph" ,  "Diprotodontian", "Peramelemorph"), pch=19, col=colsOrder, cex=0.7)
#; text(mars$Tl_mm~mars$Bl_mm, labels=mars$Species, cex=0.5)

plot(mars$Tl_mm~mars$Bl_mm, col=colsLoco[mars$Locomotor_use], pch=19, xlab="log Body length", ylab="log Tail length" ); legend("topleft",levels(mars$Locomotor_use) , pch=19, col=colsLoco, cex=0.7)



```
