---
title: "Analyses"
author: "Vera Weisbecker"
date: "5 December 2018"
output: html_document
---



## load required packages 

```{r }
library(ape)
library(geiger)
library(phytools)
library(caper)
library(car)
library(multcomp)
library(geomorph)
library(nlme)
library(dplyr)
library(RColorBrewer)
library(surface)
library(phia)
library(DescTools)
library(scales)

```

#Read in data and utilities code

```{r}

#the "utilities" file contains functions so this analysis page isn't too cluttered
source("../Analyses/Utilities.r")
load(file = "../Data/Processed_Data_for_Pgls.rda")
data_raw=read.csv("../Data/raw_data.csv", header=TRUE)

```


#First, some basic data on the quality of the raw dataset: How many percent of the dataset entries are there for each of the entry types?

```{r}


DataQuality=as.data.frame(sapply(data_raw[,2:28], function(x) sum((!is.na(x))/nrow(data_raw))*100))
colnames(DataQuality)=c ("% in raw dataset")
  
```

#the data are not normally distributed, rather they are bimodal in all cases. All model fits will therefore consider if the model residuals are regularly distributed

```{r}
par(mfrow= c(3,1))

hist(data$Bl_mm, main="Frequency distribution of log Body length (mm)", xlab= "log Body length (mm)")
hist(data$Tl_mm, main="Frequency distribution of log Tail length (mm)", xlab="log Tail length (mm) ")
hist(data$Wt_g, main="Frequency distribution of log Body mass (g)", xlab="log Weight (g)" )


```

#Is it appropriate to use species averages, rather than male/female data separately? Since in tail/body length or tail/weigth relationships are the basis for this study, confirming that there are no significant differences in slope or intercept between males- and females-only datasets


```{r}
#Re-arrange datasets to put males, femals and averages under each other, turning into a data frame for column names
  
  Males<-cbind(dataFull$Tl_Av_M,dataFull$Bl_Av_M,dataFull$Wt_Av_M, rep(1,length(dataFull$Tl_Av_M)))
  Females<-cbind(dataFull$Tl_Av_F,dataFull$Bl_Av_F,dataFull$Wt_Av_F, rep(2,length(dataFull$Tl_Av_F)))
  Averages<-cbind(dataFull$Tl_mm, dataFull$Bl_mm,dataFull$Wt_g, rep(3,length(dataFull$Bl_mm)))
  
  MarsCombine=rbind(Males, Females,Averages)
  MarsCombine=as.data.frame(MarsCombine)
  colnames(MarsCombine) <-c("Tl","Bl","Wt","Sex")
  MarsCombine$Sex<-as.factor(MarsCombine$Sex)

  
#Are there differences in slope or intercept of Tail  and body length or weight according to sex, or averages between sexes? Using Anova from the car packages because this allows type III ANOVAs where the contribution of all other effect is adjusted for while computing each individual effect
  
  ## Body length:
  
    ###check model residuals before proceeding; some low-leverage outliers which are here accepted because they are roughly on the line
    plot(lm(MarsCombine$Tl~MarsCombine$Bl*MarsCombine$Sex))
    
    ### Do regression slopes differ between sexes? 
    Anova(lm(MarsCombine$Tl~MarsCombine$Bl*MarsCombine$Sex),type = 3)
    
    
    ### No significant interactions, therefore dropping interactions to look for differences in intercept
    Anova(lm(MarsCombine$Tl~MarsCombine$Bl+MarsCombine$Sex),type = 3)
  
    
  ##Weight
  
    ###check model residuals before proceeding; no substantial outliers
    plot(lm(MarsCombine$Tl~MarsCombine$Wt*MarsCombine$Sex))
  
    ### No regression slope differences between sexes; no intercept differences either (so smaller females also have commensurately smaller tails it seems, regardless of weight or body length)
    Anova(lm(MarsCombine$Tl~MarsCombine$Wt*MarsCombine$Sex),type = 3)
    
    Anova(lm(MarsCombine$Tl~MarsCombine$Wt+MarsCombine$Sex),type = 3)
  
   
```

#Plot the male/female/average datasets over each other

```{r}
  
#plot male-only, female-only, and averaged datasets together

lwd=2

par(mfrow=c(1,2))

plot(data$Bl_Av_M,data$Tl_Av_M, col="red", pch=19, xlab="log Body length (mm)", ylab="log Tail length (mm)");
points(data$Bl_Av_F,data$Tl_Av_F, col="blue", pch=19);
points(data$Bl_mm,data$Tl_mm, col="cyan", pch=19);
abline(lm(data$Tl_Av_M~data$Bl_Av_M), col="red",lwd=lwd);
abline(lm(data$Tl_Av_F~data$Bl_Av_F), col="blue",lwd=lwd); 
abline(lm(data$Tl_mm~data$Bl_mm), col="cyan", lwd=lwd);
legend("bottomright",c("Male", "Female", "Combined") , pch=19, col=c("red","blue", "cyan"), cex=1)

plot(data$Wt_Av_M,data$Tl_Av_M, col="red", pch=19, xlab="log Body length (mm)", ylab="log Tail length (mm)");
points(data$Wt_Av_F,data$Tl_Av_F, col="blue", pch=19);
points(data$Wt_g,data$Tl_mm, col="cyan", pch=19);
abline(lm(data$Tl_Av_M~data$Wt_Av_M), col="red",lwd=lwd);
abline(lm(data$Tl_Av_F~data$Wt_Av_F), col="blue",lwd=lwd); 
abline(lm(data$Tl_mm~data$Wt_g), col="cyan", lwd=lwd);
legend("bottomright",c("Male", "Female", "Combined") , pch=19, col=c("red","blue", "cyan"), cex=1)


```


# How constrained are tail lengths, body lengths, and weights relative to each other? First, wihtin species: Body mass ranges are substantially greater than tail and body length ranges, hinting at substantial within-species independence of tail/vertebral length compared to weight.

```{r}


 ##return the min/max values to their un-logged form
  ratio_Tl=c(10^(data$Tl_max)/10^(data$Tl_min))
  ratio_Bl=c(10^(data$Bl_max)/10^(data$Bl_min))
  ratio_Wt=c(10^(data$Wt_max)/10^(data$Wt_min))
  
  mean(ratio_Tl, na.rm=TRUE)
  mean(ratio_Bl, na.rm=TRUE)
  mean(ratio_Wt, na.rm=TRUE)
  
  ##Visualizing means of the ratios 

lwd <- 2
  boxplot(ratio_Tl, ratio_Bl,ratio_Wt, names=c("Tl ratio", "Bl ratio", "Wt ratio"), col=c("hotpink1","hotpink1","cadetblue2")); 
arrows(x0=1,x1=2, y0=3, y1=3, length = 0.1, angle = 90, code=3, lwd=lwd, ); text(x=1.5, y=3.2, labels="0.48"); 
arrows(x0=2,x1=2.8, y0=4.5, y1=4.5, length = 0.1, angle = 90, code=3, lwd=lwd, ); text(x=2.4, y=4.7, labels="0.000"); 
arrows(x0=1,x1=2.8, y0=5.2, y1=5.2, length = 0.1, angle = 90, code=3, lwd=lwd, ); text(x=1.9, y=5.4, labels="0.000"); 
  
 
  ##The VarDist.test code is in utilities. It runs a Kruskal-Wallis test and then a pairwise wilcoxon rank sum test on the ratios; BL and TL do not have significant ranges, Wt is significantly greater
  ratios=c(ratio_Tl, ratio_Bl, ratio_Wt)
  
  MinMaxtest(ratios,3)
  
  
  ##This is not  because of the extreme ranges in bandicoots!
  
  ratio_Tl_Band<-ratio_Tl[ - (which(data$Order=="Peramelemorph"))]
  ratio_Bl_Band<-ratio_Bl[ - (which(data$Order=="Peramelemorph"))]
  ratio_Wt_Band<-ratio_Wt[ - (which(data$Order=="Peramelemorph"))]
  
  mean(ratio_Tl_Band, na.rm=TRUE)
  mean(ratio_Bl_Band, na.rm=TRUE)
  mean(ratio_Wt_Band, na.rm=TRUE)
  
  ratiosBand=c(ratio_Tl_Band, ratio_Bl_Band, ratio_Wt_Band)
  MinMaxtest(ratiosBand,3)
  
  mean (ratio_Tl_Band)
 
 
boxplot(ratio_Tl_Band, ratio_Bl_Band,ratio_Wt_Band, names=c("Tl ratio", "Bl ratio", "Wt ratio"), xlab="Ratios without Peramelemorpha", col=c("hotpink1","hotpink1","cadetblue2"))
      
arrows(x0=1,x1=2, y0=3, y1=3, length = 0.1, angle = 90, code=3, lwd=lwd, ); text(x=1.5, y=3.2, labels="0.44"); 
arrows(x0=2,x1=2.8, y0=4.5, y1=4.5, length = 0.1, angle = 90, code=3, lwd=lwd, ); text(x=2.4, y=4.7, labels="0.000"); 
arrows(x0=1,x1=2.8, y0=5.2, y1=5.2, length = 0.1, angle = 90, code=3, lwd=lwd, ); text(x=1.9, y=5.4, labels="0.000")


#Are arboreal and pentapedal species more constrained by their weight within species?


  ratio_Tl_ArbPent<-ratio_Tl[ c (which (data$Locomotor_use == "Arboreal") , (which (data$Locomotor_use =="Pentapedal" )))]
  ratio_Bl_ArbPent<-ratio_Bl[ c (which (data$Locomotor_use == "Arboreal") , (which (data$Locomotor_use =="Pentapedal" )))]
  ratio_Wt_ArbPent<-ratio_Wt[ c (which (data$Locomotor_use == "Arboreal") , (which (data$Locomotor_use =="Pentapedal" )))]
  
  ratio_Tl_NonArbPent<-ratio_Tl[- c (which (data$Locomotor_use == "Arboreal") , (which (data$Locomotor_use =="Pentapedal" )))]
  ratio_Bl_NonArbPent<-ratio_Bl[- c (which (data$Locomotor_use == "Arboreal") , (which (data$Locomotor_use =="Pentapedal" )))]
  ratio_Wt_NonArbPent<-ratio_Wt[- c (which (data$Locomotor_use == "Arboreal") , (which (data$Locomotor_use =="Pentapedal" )))]
  
  ratiosArbPent_Tl=c(ratio_Tl_ArbPent, ratio_Tl_NonArbPent)
  ratiosArbPent_Bl=c(ratio_Bl_ArbPent, ratio_Bl_NonArbPent)
  ratiosArbPent_Wt=c(ratio_Wt_ArbPent, ratio_Wt_NonArbPent)
  
 #for convenience running the Minmaxtest code but of course only the Kruskal-Wallis result needs to be considered
  #no significant differences in tail ranges
  MinMaxtest(ratiosArbPent_Tl,2)
  #significant but only just
  MinMaxtest(ratiosArbPent_Bl,2)
  #not significant
  MinMaxtest(ratiosArbPent_Wt,2)


```
#Phylogenetic signal of weight and body length are similar and higher than that of tail lengths. 

```{r}
# Double-checking tip labels and data row names are in the same order

tree$tip.label==rownames(data)

#the actual tree lengths result in a singular matrix that can't be decomposed; ultrametricizing the tree helps, as above.
brlentree=compute.brlen(tree)
brlentree$tip.label==rownames(data)

phylosig(brlentree, data$Tl_mm, method = "K", nsim=1000)
phylosig(brlentree, data$Bl_mm, method="K" ,nsim=1000)
phylosig(brlentree, data$Wt_g, method="K", nsim=1000)

phylosig(brlentree, data$Tl_mm, method = "lambda", nsim=1000)
phylosig(brlentree, data$Bl_mm, method="lambda" ,nsim=1000)
phylosig(brlentree, data$Wt_g, method="lambda", nsim=1000)


```

#If weight is more variable within species, it should also evolve faster than body/tail length- and it does, by nearly an order of magnitude:

```{r}
RateFrame <- data[,2:4]
matrix = c("Bl_mm", "Tl_mm", "Wt_g")

#The below gives a warning that the phylgenetic correlation matrix is singular when the untransformed tree is run. But there are no differences in significance levels regardless which one is used. Note also that the individual variables fit an OU model better than a Brownian model, but evolutionary rates are to our knowledge only testable within a Brownian motion model (Adams 2012)

rate_comp=compare.multi.evol.rates(A=RateFrame, gp=matrix, phy=compute.brlen(tree), Subset = FALSE, iter = 999, print.progress = FALSE)
                                  
summary (rate_comp)
plot(rate_comp)
rate_comp$pairwise.pvalue
rate_comp$sigma.d.gp.ratio
                                                                    


```

# How do tail lengths scale with body length and weight? Which predicts Tail length better? The find. best.model code finds the best fitting tree branch and phylogenetic correlation matrix for each model and allows to run an anova on just that.For details, see utilities.

```{r}
  
  ##Tail vs. body length: Significant and very high correlation coefficient (0.87)
  TB=find.best.model(Tl_mm~Bl_mm,tree,data);TB$AIC_Weights
  #Checking appropriate distribution of model residuals; , this is using qqnorm.gls from the nlme package. They mostly fall on a line    
  qqnorm (TB$Models$Brownian)      
  TB$Model_summaries$Brownian$tTable

  
  ##Tail vs body weight: significant but low correlation coefficient (0.33)
  TW=find.best.model(Tl_mm~Wt_g,tree,data);TW$AIC_Weights
  #Checking appropriate distribution of model residuals
  qqnorm (TB$Models$Brownian)
  TW$Model_summaries$Brownian$tTable
  
  #compute relative probabilities betweeen 0 and 100 by comparing AICS according to Burnham and Anderson
  AICs=c(TB$Model_summaries$Brownian$AIC,TW$Model_summaries$Brownian$AIC )
  AICmin=AICs-min(AICs)
  W=exp(-0.5*AICmin)/sum(exp(-0.5*AICmin))
  
  #Body length is a far better predictor of tail length:
  W 
  
```

# Weight remains a significant predictor of tail length even when correcting for body mass, but with a very low coefficient.

```{r}
      
      TBW=find.best.model(Tl_mm~Bl_mm*Wt_g,tree,data);TBW$AIC_Weights
      #Checking appropriate distribution of model residuals
      qqnorm (TBW$Models$Brownian)
      anova(TBW$Models$Brownian, type="marginal")
      
      ##dropping the interaction 
      TBWNoInter=find.best.model(Tl_mm~Bl_mm+Wt_g,tree,data);TBWNoInter$AIC_Weights
      #Checking appropriate distribution of model residuals; some low-leverage outliers deemed acceptable in this context
      qqnorm (TBWNoInter$Models$Brownian)
      anova(TBWNoInter$Models$Brownian, type="marginal")
      
      TBWNoInter$Models$Brownian$coefficients

      
```

# Aside from the association between body length and tail length,does locomotor mode play a role? 

```{r}

#There are strong interactions between locomotor mode and Body length

TB=find.best.model(Tl_mm~Bl_mm*Locomotor_use,tree,data);TB$AIC_Weights

#check if the residuals of the model are OK; the fit is quite good
#qqnorm (TB$Models$Brownian)

###look at the model summary of the most likely model: there are significant interactions 
anova(TB$Models$Brownian)

```

#In the plot, Peremelemorphs and the genus Macropus are suggestive of different intercept and slope, respectively. Thus checking if the significant interaction is driven by these two
```{r}

#Removing peramelemorphs by classifier and Macropus species from looking at the first and last Macropus in the dataset

NoPerams_Roos=data[-c(which(data$Order =="Peramelemorph"), which(data$Species=="Macropus_robustus"):which (data$Species=="Macropus_giganteus")), ]

NoPerams_RoosTree=drop.tip(tree, name.check(tree,NoPerams_Roos)$tree_not_data )

length(NoPerams_RoosTree$tip.label)
length(NoPerams_Roos$Species)

#The tree contains dasyurids and peramelids, and non-pentapedal macropods but few possums
plot(NoPerams_RoosTree)

#Testing without interactions
TBNPR=find.best.model(Tl_mm~Bl_mm*Locomotor_use,NoPerams_RoosTree,NoPerams_Roos);TBNPR$AIC_Weights

#qqplot OK
#qqnorm (TBNAPNoInter$Models$Brownian)

#Still a significant interaction between locomotor uses
anova(TBNPR$Models$Brownian, type="marginal")


```

#Since the two most different groups (Peramelemorphs and Macropus) do not change the significance  of body length and locomotor use interaction, running a post-hoc analysis on the entire dataset. It is not possible to do post-hoc test in the pgls framework, so instead looking for interactions in the non-phylogenetically corrected lm analysis and using testInteractions from the phia package. 

```{r}

TB_lm <- lm(Tl_mm~Bl_mm*Locomotor_use, data=data)
testInteractions(TB_lm, adjustment="holm")

```


#Arboreal species (mostly possums) scale differently to terrestrial species (mostly dasyurids and peramelids), but not scansorial (mostly dasyurid) or pentapedal (large macropod) species. This is consistent with the expectation that pentapedal and arboreal species use their tail heavily in locomotion and would thus reflect a difference to the more generalist terrestrial modes. However, despite the use of pgls, the dataset is phylogenetically heavily confounded so that the result could conceivably arise from a very strong phylogenetic signal of locomotion. This possibility is excluded by analysing a model that uses phylogenetic distinctions does not result in significant interactions between major clade (order or diprotodontian family):

```{r}

TB=find.best.model(Tl_mm~Bl_mm*Order,tree,data);TB$AIC_Weights

#check if the residuals of the model are OK; the fit is quite good
#qqnorm (TB$Models$Brownian)

###look at the model summary of the most likely model: there are significant interactions 
anova(TB$Models$Brownian)

#a test of the uncorrected lm model also suggests no differences in scaling slope:

anova(TB_lm <- lm(Tl_mm~Bl_mm*Order, data=data))

```

#To look for differences in means, which may also contribute to differences in relative tail length between locomotor modes, we separate arboreal and pentapedal species from the remainder under the assumption that these two represent heavy tail use and are therefore expected to evolve differently to others. This shows that non-pentapedal, non-arboreal marsupials - including bounding but not pentapedal kangaroos - have the same intercept

```{r}

#prepare tree
NonArbPent=data[c(which(data$Locomotor_use =="Terrestrial"), which ( data$Locomotor_use =="Scansorial"), which(data$Locomotor_use =="Saltatorial")),]

NonArbPentTree=drop.tip(tree, name.check(tree,NonArbPent)$tree_not_data )

#prepare arboreal and pentapedal only for later plotting as well
Arb=data[c(which(data$Locomotor_use =="Arboreal")),]
Arb_Tree=drop.tip(tree, name.check(tree,Arb)$tree_not_data )
Pent=data[c(which(data$Locomotor_use =="Pentapedal")),]
Pent_Tree=drop.tip(tree, name.check(tree,Pent)$tree_not_data )


#The tree contains dasyurids and peramelids, and non-pentapedal macropods but few possums
plot(NonArbPentTree)

#Testing without interactions
TBNAP=find.best.model(Tl_mm~Bl_mm+Locomotor_use,NonArbPentTree,NonArbPent);TBNAP$AIC_Weights

#this is quite good and seems to fit the data better than the model with interaction
#qqnorm (TBNAPNoInter$Models$Brownian)

###No differences in intercep
anova(TBNAP$Models$Brownian, type="marginal")

```

#Arboreal and pentapedal species also share their intercept

```{r}

#prepare tree
ArbPent=data[-c(which(data$Locomotor_use =="Terrestrial"), which ( data$Locomotor_use =="Scansorial"), which(data$Locomotor_use =="Saltatorial")),]

ArbPentTree=drop.tip(tree, name.check(tree,ArbPent)$tree_not_data )

#Also preparing tree for just pentapedal kangaroos for plotting below, although not used here
Pent=data[which(data$Locomotor_use =="Pentapedal"),]

Pent_Tree=drop.tip(tree, name.check(tree,Pent)$tree_not_data )

#The tree contains mostly Diprotodontia
plot(ArbPentTree)

#Note that this model is one of the few that fits a Grafen-transformed and/or scaled branch transformation better; but a Brownian model does not change the intercept
TBAP=find.best.model(Tl_mm~Bl_mm+Locomotor_use,ArbPentTree,ArbPent);TBAP$AIC_Weights

#this is quite good 
qqnorm (TBAP$Models$Grafen)

###No differences in intercept here, either.
anova(TBAP$Models$Grafen, type="marginal")


anova(TBAP$Models$Grafen, type="marginal")
#A Brownian motion correlation structure (used for the larger dataset analyses) does not change the significance level. 
anova(TBAP$Models$Brownian, type="marginal")

```



#With body weight, there are two instances of arboreal scaling being different to two others; so again, assuming that arboreal species are the ones that are different

```{r}
#The relationship of tail length and locomotor use changes at different weights

TW=find.best.model(Tl_mm~Wt_g*Locomotor_use,tree,data);TW$AIC_Weights

#check if the residuals of the model are OK; the fit is quite good
qqnorm (TW$Models$Brownian)

###look at the model summary of the most likely model: there are also significant interactions here
anova(TW$Models$Brownian, type="marginal")

#again, use non-phylogenetic interaction test; with weight, only arboreal species seem different though

TW_lm <- lm(Tl_mm~Wt_g*Locomotor_use, data=data)
testInteractions(TW_lm, adjustment="holm")

```


# Removing the arboreal species, which we assume are the ones driving the interaction differences, reveals differences in mean betweeen terrestrial species and others. 

```{r}
#prepare tree
NonArb=data[-c(which(data$Locomotor_use =="Arboreal")),]

NonArbTree=drop.tip(tree, name.check(tree,NonArb)$tree_not_data )

#also prepare the opposite tree for plotting later, although not used in analysis
Arb=data[c(which(data$Locomotor_use =="Arboreal")),]

Arb_Tree=drop.tip(tree, name.check(tree,Arb)$tree_not_data )


#The tree contains dasyurids and peramelids, and non-pentapedal macropods but few possums
plot(NonArbTree)

#Model
TWNA=find.best.model(Tl_mm~Wt_g+Locomotor_use,NonArbTree,NonArb);TWNA$AIC_Weights

#qqnorm fit is OK, again with just a couple of "tails"
#qqnorm (TWNA$Models$Brownian)

###Differences in tail/weight scaling here
anova(TWNA$Models$Brownian, type = "marginal")


#again, no post-hoc tests can be run on pgls analyses, so using non-phylogenetic one here

NonArb_Tukey=aov(Tl_mm~Wt_g+Locomotor_use, data=NonArb)

TukeyHSD(NonArb_Tukey, "Locomotor_use")

#The above gives an odd error message that I have not seen before; but clearly it is not ignoring the contribution of the weight data to the model, which is reassuring:

NonArb_Tukey1=aov(Tl_mm~Locomotor_use, data=NonArb)

TukeyHSD(NonArb_Tukey1)

```




 
 
#Plotting according to tail use, locomotor mode, and phylogeny - weight and length are very similar, so I suspect one can be taken out in the end.

```{r}

#determine the regression line coefficients from all the different pgls analyses conducted above, with separate lines where differences in slope or intercept were found.

Arbline_Bl_F <-gls(Tl_mm~Bl_mm, correlation=corBrownian (1,phy=Arb_Tree), data=Arb)
Arbline_Bl <- pgls.line.text(Arbline_Bl_F$coefficients[1],Arbline_Bl_F$coefficients[2], 1.8,2.8)

Pentline_Bl_F <-gls(Tl_mm~Bl_mm, correlation=corBrownian (1,phy=Pent_Tree), data=Pent)
Pentline_Bl <- pgls.line.text(Pentline_Bl_F$coefficients[1],Pentline_Bl_F$coefficients[2], 2.6,3.2)

Arbline_Wt_F <-gls(Tl_mm~Wt_g, correlation=corBrownian (1,phy=Arb_Tree), data=Arb)
Arbline_Wt <- pgls.line.text(Arbline_Wt_F$coefficients[1],Arbline_Wt_F$coefficients[2], 0.8 ,3.5)

Allothers_Bl_F <-gls(Tl_mm~Bl_mm, correlation=corBrownian (1,phy=NonArbPentTree), data=NonArbPent)
Allothers_Bl <- pgls.line.text(Allothers_Bl_F$coefficients[1],Allothers_Bl_F$coefficients[2], 1.8,3.1)

Allothers_Wt_F <-gls(Tl_mm~Wt_g, correlation=corBrownian (1,phy=NonArbTree), data=NonArb)
Allothers_Wt <- pgls.line.text(Allothers_Wt_F$coefficients[1],Allothers_Wt_F$coefficients[2], 0.7,4.5)


# initial setup: colours and margins
  #colsOrderM=brewer.pal(n=2+length(levels(data$Order)), name="Paired")
  colsLoco=brewer.pal(n=3+length(levels(data$Locomotor_use)), name="Dark2")
  colsLoco=c("dark orange", "purple", "green", "red", "blue")
  pchs=c(8,11,19,17,20,15)
  ##Size of points
  cexes <- 1
  ## this adjusts the titles of the double panel
  adjs <- -0.3
  ## spaces to the left of text
  xinter <- 1
  ## spaces between legend lines
  yInter <- 0.3
  ##size of the box is determined by text width
  textwidth <- 0.2
  
  
    
##4 panels, with margins of 2 lines
par(mfrow=c(2,1), mar = c(4,4,4,4))
  

plot(data$Tl_mm~data$Bl_mm, col=colsLoco[data$Locomotor_use], pch = pchs[data$Order], xlab="log Body length (mm)", ylab="log Tail length" ); 
legend("bottomright",inset=0.08,levels(data$Locomotor_use) , pch=19, col=colsLoco, cex=cexes, x.intersp = xinter, y.intersp = yInter, text.width = textwidth, bty="n");  
legend("topleft", "a", bty="n", cex=1.5, inset=-0.05);
lines(x=c(1.8,2.8),y=c(1.8776347281739,2.76827754516716), col=colsLoco[1], lwd=2); lines(x=c(2.6,3.2),y=c(2.60573488742311,2.93380010371888), col=colsLoco[2], lwd=2);
lines(x=c(1.8,3.1),y=c(1.69042118446694,2.7933259492651), col="Black", lwd=2);
#text(data$Tl_mm~data$Bl_mm, labels=data$Species, cex=0.5)

#the below is to show that the linear model without correction returns a far higher intercept than the pgls
#abline(lm(Arb$Tl_mm~Arb$Bl_mm))
#abline(lm(NonArb$Tl_mm~NonArb$Bl_mm))
#text(data$Tl_mm~data$Bl_mm, labels=data$Species, cex=0.5)
  
plot(data$Tl_mm~data$Wt_g, col=colsLoco[data$Locomotor_use], pch = pchs[data$Order], xlab="log Weight (g)", ylab="log Tail length" );
legend("bottomright",inset=0.12,levels(data$Order) , pch=pchs,  cex=cexes,x.intersp = xinter, y.intersp = yInter, text.width = textwidth, bty="n" );
legend("topleft", "b", bty="n", cex=1.5,inset=-0.05);
lines(x=c(0.8,3.5),y=c(1.85285512787502,2.6583303053621), col=colsLoco[1], lwd=2);
lines(x=c(0.7,4.5),y=c(1.72467611669273,2.97159755686062),col="Black", lwd=2)
  
#plotting by phylogenetic affinity; but not sure how useful this is
  
  #plot(data$Tl_mm~data$Wt_g, col=colsOrderM[data$Order], pch=19, xlab="log Weight (g)", ylab="log Tail length") ;legend("bottomright", c("Dasyuromorph" ,  "Diprotodontian", "Peramelemorph"),inset=inset, pch=19, col=colsOrderM, cex=cexes,y.intersp = yInter, x.intersp = xinter,text.width = textwidth+0.1, bty="n" ); #text(data$Tl_mm~data$Wt_g, labels=data$Species, cex=0.5)
  
  #plot(data$Tl_mm~data$Bl_mm, col=colsOrderM[data$Order], pch=19, xlab="log Body length", ylab="log Tail length") ;legend("bottomright", c("Dasyuromorph" ,  "Macropod", "Peramelemorph", "Possum"),inset=inset, pch=19, col=colsOrderM, cex=cexes,y.intersp = yInter, x.intersp = xinter,text.width = textwidth+0.1, bty="n" );  #text(data$Tl_mm~data$Bl_mm, labels=data$Species, cex=0.5)

```
 
#A plot that includes ranges as ellipses using the DescTools package for ellipses and scale package for transparency setting
 
```{r}
data_ranges_Bl <- data[-c(which(is.na(data$Tl_min)), which (is.na(data$Bl_min))),]
data_ranges_Wt <- data[-c(which(is.na(data$Tl_min)), which (is.na(data$Wt_min))),]


#par(mfrow=c(2,1))

#Tail vs body length: 


plot(data_ranges_Bl$Tl_mm~data_ranges_Bl$Bl_mm, col=colsLoco[data$Locomotor_use], pch = pchs[data$Order], xlab="log Body length (mm)", ylab="log Tail length" , xlim=c(1.6,3.5), ylim=c(1.5,3.3) , asp=1); 


DrawEllipse(x=data_ranges_Bl$Bl_mm, y=data_ranges_Bl$Tl_mm, radius.x = (data_ranges_Bl$Bl_max - data_ranges_Bl$Bl_min), radius.y = (data_ranges_Bl$Tl_max - data_ranges_Bl$Tl_min), col=alpha (colsLoco[data$Locomotor_use] , 0.05), border=colsLoco[data$Locomotor_use]);

points(data_ranges_Bl$Tl_mm~data_ranges_Bl$Bl_mm, col="black", pch = pchs[data$Order]);

legend("bottomright",inset=0.08,levels(data$Locomotor_use) , pch=19, col=colsLoco, cex=cexes, x.intersp = xinter, y.intersp = yInter, text.width = textwidth, bty="n");  

legend("topleft", "a", bty="n", cex=1.5, inset=-0.05);

#first draw wider lines to give a black "frame"
lines(x=c(1.8,2.8),y=c(1.8776347281739,2.76827754516716), col="black", lwd=5); lines(x=c(2.6,3.2),y=c(2.60573488742311,2.93380010371888), col="black", lwd=5);
lines(x=c(1.8,3.1),y=c(1.69042118446694,2.7933259492651), col="black", lwd=5);

#then the coloured lines for filling in
lines(x=c(1.8,2.8),y=c(1.8776347281739,2.76827754516716), col=colsLoco[1], lwd=3); lines(x=c(2.6,3.2),y=c(2.60573488742311,2.93380010371888), col=colsLoco[2], lwd=3);
lines(x=c(1.8,3.1),y=c(1.69042118446694,2.7933259492651), col="Black", lwd=3)

#Tail vs body weight:


plot(data_ranges_Wt$Tl_mm~data_ranges_Wt$Wt_g, col=colsLoco[data$Locomotor_use], pch = pchs[data$Order], xlab="log Weigth (g)", ylab="log Tail length" , xlim=c(0.3,5.3), ylim=c(1.2,3.3), asp=1 ); 

DrawEllipse(x=data_ranges_Wt$Wt_g, y=data_ranges_Wt$Tl_mm, radius.x = (data_ranges_Wt$Wt_max - data_ranges_Wt$Wt_min), radius.y = (data_ranges_Wt$Tl_max - data_ranges_Wt$Tl_min), col=alpha (colsLoco[data$Locomotor_use] , 0.05), border=colsLoco[data$Locomotor_use]);

points(data_ranges_Wt$Tl_mm~data_ranges_Wt$Wt_g, col="black", pch = pchs[data$Order]);
legend("bottomright",inset=0.12,levels(data$Order) , pch=pchs,  cex=cexes,x.intersp = xinter, y.intersp = yInter, text.width = textwidth, bty="n" );

legend("topleft", "b", bty="n", cex=1.5,inset=-0.05)

#first draw wider lines to give a black "frame"
lines(x=c(0.8,3.5),y=c(1.85285512787502,2.6583303053621), col="Black", lwd=5);
lines(x=c(0.7,4.5),y=c(1.72467611669273,2.97159755686062),col="Black", lwd=5)

#then the coloured lines for filling in
lines(x=c(0.8,3.5),y=c(1.85285512787502,2.6583303053621), col=colsLoco[1], lwd=3);
lines(x=c(0.7,4.5),y=c(1.72467611669273,2.97159755686062),col="Black", lwd=3)



```
 
 