---
title: "Analyses"
author: "Vera Weisbecker and Cruise Speck"
date: "5 December 2018"
output: html_document
---



## load required packages and processed data



```{r }
library(ape)
library(geiger)
library(phytools)
library(caper)
library(car)
library(multcomp)
library(geomorph)
library(lmSupport)
library(ggplot2)
library(nlme)
library(dplyr)
library(RColorBrewer)
library(surface)
library(phia)


#the "utilities" file contains functions so this analysis page isn't too cluttered
source("../Analyses/Utilities.r")
load(file = "../Data/Processed_Data_for_Pgls.rda")
data_raw=read.csv("../Data/raw_data.csv", header=TRUE)

```


#First, some basic data on the quality of the raw dataset: How many percent of the dataset entries are there for each of the entry types?

```{r}


DataQuality=as.data.frame(sapply(data_raw[,2:28], function(x) sum((!is.na(x))/nrow(data_raw))*100))
colnames(DataQuality)=c ("% in raw dataset")
  
```

#Phylogenetic signal of tail length, head and body length, and body weight

```{r}
# Double-checking tip labels and data row names are in the same order

tree$tip.label==rownames(data)

#the actual tree lengths result in a singular matrix that can't be decomposed; ultrametricizing the tree helps
brlentree=compute.brlen(tree)
brlentree$tip.label==rownames(data)

phylosig(brlentree, data$Tl_mm, method = "K", nsim=1000)
phylosig(brlentree, data$Bl_mm, method="K" ,nsim=1000)
phylosig(brlentree, data$Wt_g, method="K", nsim=1000)


#lambda works on the tree but gives a different, very high phylogenetic signal

phylosig(tree, data$Tl_mm, method = "lambda", nsim=1000)
phylosig(tree, data$Bl_mm, method="lambda", nsim=1000)
phylosig(tree, data$Wt_g, method="lambda", nsim=1000)

```


# Testing the hypothesis that within-species body weight maxima are greater relative to body weight minima(i.e. the range is relatively wider), compared to the same ratio in within-species body or tail lengths) - for those species where ranges are available, body mass ranges are substantially greater

```{r}
#Marsupials

  ##return the min/max values to their un-logged form
  ratio_Tl=c(10^(dataFull$Tl_max)/10^(dataFull$Tl_min))
  ratio_Bl=c(10^(dataFull$Bl_max)/10^(dataFull$Bl_min))
  ratio_Wt=c(10^(dataFull$Wt_max)/10^(dataFull$Wt_min))
  
  ##Visualizing means of the ratios 
  boxplot(ratio_Tl, ratio_Bl,ratio_Wt, names=c("Tl ratio", "Bl ratio", "Wt ratio"))
  
  
  
  ##The VarDist.test code is in utilities. It runs a Kruskal-Wallis test and then a pairwise wilcoxon rank sum test on the ratios
  ratios=c(ratio_Tl, ratio_Bl, ratio_Wt)
  
  MinMaxtest(ratios,3)
  
  
  ##This is not mainly because of the extreme ranges in bandicoots!
  
  ratio_Tl_Band<-ratio_Tl[ - (grep("Macrotis_leucura", dataFull$Species):grep("Echymipera_rufescens", dataFull$Species))]
  ratio_Bl_Band<-ratio_Bl[ - (grep("Macrotis_leucura", dataFull$Species):grep("Echymipera_rufescens", dataFull$Species))]
  ratio_Wt_Band<-ratio_Wt[ - (grep("Macrotis_leucura", dataFull$Species):grep("Echymipera_rufescens", dataFull$Species))]
  
  ratiosBand=c(ratio_Tl_Band, ratio_Bl_Band, ratio_Wt_Band)
  MinMaxtest(ratiosBand,3)
  
  par(mfrow=c(1,2))
  boxplot(ratio_Tl, ratio_Bl,ratio_Wt, xlab="ratios with bandicoots")
  boxplot(ratio_Tl_Band, ratio_Bl_Band,ratio_Wt_Band, xlab="ratios without bandicoots")



```

#is there a difference in tail/body length or tail/weigth relationships between the sexes? This is only possible in a non phylogenetic context

```{r}
#Re-arrange datasets to put males, femals and averages under each other, turning into a data frame for column names
  
  Males<-cbind(dataFull$Tl_Av_M,dataFull$Bl_Av_M,dataFull$Wt_Av_M, rep(1,length(dataFull$Tl_Av_M)))
  Females<-cbind(dataFull$Tl_Av_F,dataFull$Bl_Av_F,dataFull$Wt_Av_F, rep(2,length(dataFull$Tl_Av_F)))
  Averages<-cbind(dataFull$Tl_mm, dataFull$Bl_mm,dataFull$Wt_g, rep(3,length(dataFull$Bl_mm)))
  
  MarsCombine=rbind(Males, Females,Averages)
  MarsCombine=as.data.frame(MarsCombine)
  colnames(MarsCombine) <-c("Tl","Bl","Wt","Sex")
  MarsCombine$Sex<-as.factor(MarsCombine$Sex)

  
#Are there differences in slope or intercept of Tail  and body length or weight according to sex, or averages between sexes? Using Anova from the car packages because this allows type III ANOVAs where the contribution of all other effect is adjusted for while computing each individual effect
  
  ## Body length:
  
    ###check model residuals before proceeding; some low-leverage outliers which are here accepted
    plot(lm(MarsCombine$Tl~MarsCombine$Bl*MarsCombine$Sex))
    
    ### Do regression slopes differ between sexes? 
    Anova(lm(MarsCombine$Tl~MarsCombine$Bl*MarsCombine$Sex),type = 3)
    
    
    ### No significant interactions, therefore dropping interactions to look for differences in intercept
    Anova(lm(MarsCombine$Tl~MarsCombine$Bl+MarsCombine$Sex),type = 3)
  
    
  ##Weight
  
    ###check model residuals before proceeding; no substantial outliers
    plot(lm(MarsCombine$Tl~MarsCombine$Wt*MarsCombine$Sex))
  
    ### No regression slope differences between sexes; no intercept differences either (so smaller females also have commensurately smaller tails it seems, regardless of weight or body length)
    Anova(lm(MarsCombine$Tl~MarsCombine$Wt*MarsCombine$Sex),type = 3)
    
    Anova(lm(MarsCombine$Tl~MarsCombine$Wt+MarsCombine$Sex),type = 3)
  
   
```

# How do tail lengths scale with body length and weight? Which predicts Tail length better? The find. best.model code finds the best fitting tree branch and phylogenetic correlation matrix for each model and allows to run an anova on just that.For details, see utilities.

```{r}
  
  ##Tail vs. body length: Significant and very high correlation coefficient (0.87)
  TB=find.best.model(Tl_mm~Bl_mm,tree,data);TB$AIC_Weights
  #Checking appropriate distribution of model residuals; , this is using qqnorm.gls from the nlme package. They mostly fall on a line    
  qqnorm (TB$Models$Brownian)      
  TB$Model_summaries$Brownian$tTable

  
  ##Tail vs body weight: significant but low correlation coefficient (0.33)
  TW=find.best.model(Tl_mm~Wt_g,tree,data);TW$AIC_Weights
  #Checking appropriate distribution of model residuals
  qqnorm (TB$Models$Brownian)
  TW$Model_summaries$Brownian$tTable
  
  #compute relative probabilities betweeen 0 and 100 by comparing AICS according to Burnham and Anderson
  AICs=c(TB$Model_summaries$Brownian$AIC,TW$Model_summaries$Brownian$AIC )
  AICmin=AICs-min(AICs)
  W=exp(-0.5*AICmin)/sum(exp(-0.5*AICmin))
  
  #Not surprisingly, body length is a far better predictor of body length:
  W 
  
```

# Weight remains a significant predictor of tail length even when correcting for body mass, but with a very low coefficient

```{r}
      
      TBW=find.best.model(Tl_mm~Bl_mm*Wt_g,tree,data);TBW$AIC_Weights
      #Checking appropriate distribution of model residuals
      qqnorm (TBW$Models$Brownian)
      anova(TBW$Models$Brownian, type="marginal")
      
      ##dropping the interaction 
      TBWNoInter=find.best.model(Tl_mm~Bl_mm+Wt_g,tree,data);TBWNoInter$AIC_Weights
      #Checking appropriate distribution of model residuals; some low-leverage outliers deemed acceptable in this context
      qqnorm (TBWNoInter$Models$Brownian)
      anova(TBWNoInter$Models$Brownian, type="marginal")
      
      TBWNoInter$Models$Brownian$coefficients

      
```

# Aside from the association between body length and tail length,does locomotor mode play a role? Note: using the smaller, m/f specific datasets is not possible with interactions, so if interactions are found it seems inappropriate to run them

#The below is for tail length vs. body length
```{r}

#There are strong interactions between locomotor mode

TB=find.best.model(Tl_mm~Bl_mm*Locomotor_use,tree,data);TB$AIC_Weights

#check if the residuals of the model are OK; the fit is quite good
qqnorm (TB$Models$Brownian)

###look at the model summary of the most likely model: there are significant interactions 
anova(TB$Models$Brownian)

#It is not possible to do post-hoc test in the pgls framework, so instead looking for interactions in the non-phylogenetically corrected lm analysis and using testInteractions from the phia package. Also refer to the plot. 

TB_lm <- lm(Tl_mm~Bl_mm*Locomotor_use, data=data)
testInteractions(TB_lm, adjustment="holm")
```

#Arboreal species (mostly possums) scale differently to terrestrial species (mostly dasyurids and peramelids), but not scansorial (mostly dasyurid) or pentapedal (large macropod) species.This could be due to the strong phylogenetic signal of locomotion; however, fitting a model that uses phylogenetic distinctions does not result in significant interactions between major clade (order or diprotodontian family):

```{r}

TB=find.best.model(Tl_mm~Bl_mm*Order,tree,data);TB$AIC_Weights

#check if the residuals of the model are OK; the fit is quite good
qqnorm (TB$Models$Brownian)

###look at the model summary of the most likely model: there are significant interactions 
anova(TB$Models$Brownian)

#a post-hoc test of the uncorrected lm model also suggests no differences in scaling slope:

anova(TB_lm <- lm(Tl_mm~Bl_mm*Order, data=data))

```

#To look for differences in means, which may also contribute to differences in relative tail length between locomotor modes, we separate arboreal and pentapedal species to look at just saltators, scansorial, and terrestrial species. This shows that non-pentapedal, non-arboreal marsupials - even if including bounding but not pentapedal kangaroos - share the same scaling slope AND intercept!

```{r}

#prepare tree
NonArbPent=data[c(which(data$Locomotor_use =="Terrestrial"), which ( data$Locomotor_use =="Scansorial"), which(data$Locomotor_use =="Saltatorial")),]

NonArbPentTree=drop.tip(tree, name.check(tree,NonArbPent)$tree_not_data )

#The tree contains dasyurids and peramelids, and non-pentapedal macropods but few possums
plot(NonArbPentTree)

#model

TBNAP=find.best.model(Tl_mm~Bl_mm*Locomotor_use,NonArbPentTree,NonArbPent);TBNAP$AIC_Weights

#check if the residuals of the model are OK; the fit is ok with some spread at the ends of the distribution
qqnorm (TBNAP$Models$Brownian)

###look at the model summary of the most likely model; there are no significant interactions
anova(TBNAP$Models$Brownian)

#Testing without interactions
TBNAPNoInter=find.best.model(Tl_mm~Bl_mm+Locomotor_use,NonArbPentTree,NonArbPent);TBNAPNoInter$AIC_Weights

#this is quite good and seems to fit the data better than the model with interaction
qqnorm (TBNAPNoInter$Models$Brownian)

###No differences in intercept!!
anova(TBNAPNoInter$Models$Brownian)

```



##Tail vs body WEIGHT

```{r}
TW=find.best.model(Tl_mm~Wt_g*Locomotor_use,tree,data);TW$AIC_Weights
anova(TW$Model_summaries$corBrownian, type="marginal")  

###no interactions, therefore
TW_no_inter=find.best.model(Tl_mm~Wt_g+Locomotor_use,tree,data);TW$AIC_Weights
anova(TW_no_inter$Model_summaries$corBrownian, type="marginal") 


###using the smaller, m/f specific datasets
TWF=find.best.model(Tl_Av_F ~Wt_Av_F+Locomotor_use,mf_tree, mf_data);TW$AIC_Weights
anova(TWF$Model_summaries$corBrownian, type="marginal") 

TWM=find.best.model(Tl_Av_M~Wt_Av_M+Locomotor_use,mf_tree,mf_data);TW$AIC_Weights
anova(TWF$Model_summaries$corBrownian, type="marginal") 
   



#BIN - delete later


#or use phytools - not sure how to deal with the label warnings
Locomotor_use=c(data$Locomotor_use)
names(Locomotor_use)<-names(data$Species)
phylANOVA(tree,Locomotor_use,data$Tl_mm)



```


#Plotting male, female and averages 

```{r}
#Using the SURFACE package to look for significant shifts in evolutoinary regime
  
ForSurf=as.data.frame(cbind(mars$Tl_mm, mars$Bl_mm))
colnames(ForSurf) <- c("T1", "BL")
rownames(ForSurf) <- rownames(mars)

MarsSurfTree<-nameNodes(marsTree)
olist<-convertTreeData(MarsSurfTree,ForSurf)
otree<-olist[[1]]; odata<-olist[[2]]

fwd<-surfaceForward(otree, odata)
k<-length(fwd)

bwd<-surfaceBackward(otree, odata, starting_model = fwd[[k]], aic_threshold = 0, only_best = TRUE, verbose = FALSE, plotaic = FALSE)
bsum<-surfaceSummary(bwd)
kk<-length(bwd)

fsum=surfaceSummary(fwd)
bsum <- surfaceSummary(bwd)

surfaceTreePlot(MarsSurfTree, bwd[[kk]], labelshifts = T)

```








```{r}
  
#plot male-only, female-only, and averaged datasets together - Marsupials only 

par(mfrow=c(1,2))

plot(mars$Bl_Av_M,mars$Tl_Av_M, col="red", pch=19);points(mars$Bl_Av_F,mars$Tl_Av_F, col="blue", pch=19);points(mars$Bl_mm,mars$Tl_mm, col="green", pch=19);abline(lm(mars$Tl_Av_M~mars$Bl_Av_M), col="red");abline(lm(mars$Tl_Av_F~mars$Bl_Av_F), col="blue"); abline(lm(mars$Tl_mm~mars$Bl_mm), col="green")


plot(mars$Wt_Av_M,mars$Tl_Av_M, col="red", pch=19);points(mars$Wt_Av_F,mars$Tl_Av_F, col="blue", pch=19);points(mars$Wt_g,mars$Tl_mm, col="green", pch=19);abline(lm(mars$Tl_Av_M~mars$Wt_Av_M), col="red");abline(lm(mars$Tl_Av_F~mars$Wt_Av_F), col="blue"); abline(lm(mars$Tl_mm~mars$Wt_g), col="green")  


```

#Plotting according to tail use and phylogeny - body length

```{r}
#Marsupials
  
  ## initial setup: colours and margins
    colsOrderM=brewer.pal(n=length(levels(mars$Order)), name="Dark2")
    colsLoco=brewer.pal(n=length(levels(mars$Locomotor_use)), name="Dark2")
    colsOrderR=brewer.pal(n=length(levels(rodFull$Order)), name="Dark2")
    # Size of points
    cexes <- 1
    # this adjusts the titles of the double panel
    adjs <- -0.3
    # spaces to the left of text
    xinter <- 0.2
     # spaces between legend lines
    yInter <- 0.25
    #size of the box is determined by text width
    textwidth <- 0.2
    #insets the box a bit
    inset <- 0.01
  
    
    #4 panels, with margins of 2 lines
    par(mfrow=c(2,2), mar = c(4,4,4,4))
  
  plot(mars$Tl_mm~mars$Bl_mm, col=colsOrderM[mars$Order], pch=19, xlab="log Body length", ylab="log Tail length") ;legend("bottomright", c("Dasyuromorph" ,  "Diprotodontian", "Peramelemorph"),inset=inset, pch=19, col=colsOrderM, cex=cexes,y.intersp = yInter, x.intersp = xinter,text.width = textwidth+0.1, bty="n" ); #text(mars$Tl_mm~mars$Bl_mm, labels=mars$Species, cex=0.5)
  
  plot(mars$Tl_mm~mars$Bl_mm, col=colsLoco[mars$Locomotor_use], pch=19, xlab="log Body length", ylab="log Tail length" ); legend("bottomright",inset=inset,levels(mars$Locomotor_use) , pch=19, col=colsLoco, cex=cexes, x.intersp = xinter, y.intersp = yInter, text.width = textwidth, bty="n")
  
  mtext("Marsupials", adj=adjs,side=3, line=2, cex=1)
  
  ##Rodents
  
  plot(rodFull$Tl_mm~rodFull$Bl_mm, col=colsOrderR[rodFull$Order], pch=19, xlab="log Body length", ylab="log Tail length" );legend("bottomright", c("Murine" ,  "Rattus"),inset=inset, pch=19, col=colsOrderR, cex=cexes, x.intersp = xinter, y.intersp = yInter, text.width = textwidth-0.1, bty="n"); #text(rodFull$Tl_mm~rodFull$Bl_mm, labels=rodFull$Species, cex=cexes)
  
  plot(rodFull$Tl_mm~rodFull$Bl_mm, col=colsLoco[rodFull$Locomotor_use], pch=19, xlab="log Body length", ylab="log Tail length" ); legend("bottomright", inset=inset,levels(rodFull$Locomotor_use) , pch=19, col=colsLoco, cex=cexes,  ncol=2, x.intersp = xinter, y.intersp = yInter, text.width = textwidth-0.1, bty="n")
  
  mtext("Rodents", adj=adjs, line=2, cex = 1)

```


#Plotting according to tail use and phylogeny - body mass ADJUST ACCORDING TO ABOVE WHEN DONE

```{r}

  ##Marsupials
  
  
    ## initial setup: colours and margins
    colsOrderM=brewer.pal(n=length(levels(mars$Order)), name="Dark2")
    colsLoco=brewer.pal(n=length(levels(mars$Locomotor_use)), name="Dark2")
    colsOrderR=brewer.pal(n=length(levels(rodFull$Order)), name="Dark2")
    cexes<-0.6
    adjs=-0.3
    x.intersp=1
    
    #4 panels, with margins of 2 lines
    par(mfrow=c(2,2), mar = c(4,4,4,4))
  
  plot(mars$Tl_mm~mars$Wt_g, col=colsOrderM[mars$Order], pch=19, xlab="log Body mass", ylab="log Tail length" );legend("bottomright", c("Dasyuromorph" ,  "Diprotodontian", "Peramelemorph"), pch=19, col=colsOrderM, cex=cexes); #text(mars$Tl_mm~mars$Wt_g, labels=mars$Species, cex=0.5)
  
  plot(mars$Tl_mm~mars$Wt_g, col=colsLoco[mars$Locomotor_use], pch=19, xlab="log Body mass", ylab="log Tail mass" ); legend("bottomright",levels(mars$Locomotor_use) , pch=19, col=colsLoco, cex=cexes)
  
  mtext("Marsupials", adj=adjs,side=3, line=2, cex=1)
  
  ##Rodents
  
  plot(rodFull$Tl_mm~rodFull$Wt_g, col=colsOrderR[rodFull$Order], pch=19, xlab="log Body mass", ylab="log Tail length" );legend("bottomright", c("Murine" ,  "Rattus"), pch=19, col=colsOrderR, cex=cexes); #text(rodFull$Tl_mm~rodFull$Wt_g, labels=rodFull$Species, cex=cexes)
  
  plot(rodFull$Tl_mm~rodFull$Wt_g, col=colsLoco[rodFull$Locomotor_use], pch=19, xlab="log Body mass", ylab="log Tail length" ); legend("bottomright",levels(rodFull$Locomotor_use) , pch=19, col=colsLoco, cex=cexes)
  
  mtext("Rodents", adj=adjs, line=2, cex = 1)

```
